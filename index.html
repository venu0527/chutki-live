<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chutki — Event Finder (All-in-one)</title>

  <!-- Tailwind CDN (for styling) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

  <!-- React / ReactDOM (UMD builds) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Leaflet (maps) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --muted: #9aa4b2; --bg1: #071029; --bg2: #071528; }
    html,body,#root { height:100%; margin:0; }
    body { font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#e6eef6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card { background: rgba(255,255,255,0.03); border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,0.03); box-shadow: 0 8px 30px rgba(2,6,23,0.6); }
    .section-row { display:flex; gap:12px; overflow-x:auto; padding-bottom:6px; scroll-behavior:smooth; }
    .section-card { min-width:260px; flex:0 0 auto; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
    .event-image { width:100%; height:140px; object-fit:cover; border-radius:8px; margin-bottom:8px; }
    .small { font-size:13px; color:var(--muted); }
    .tag { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; color:#fff; }
    #map { height:320px; border-radius:8px; margin-bottom:10px; }
    /* hide small scrollbars */
    .section-row::-webkit-scrollbar { height:8px; } .section-row::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius:8px; }
    .fade-in { opacity:0; transform:translateY(6px); animation:fadeIn 0.6s forwards; }
    @keyframes fadeIn { to { opacity:1; transform:none; } }
    .carousel { display:flex; gap:12px; overflow:hidden; }
    .carousel-track { display:flex; transition:transform 0.6s ease; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
  (function(){
    const e = React.createElement;
    const { useState, useEffect, useRef } = React;

    // ---------------------------
    // CONFIG — replace if needed
    // ---------------------------
    const SUPABASE_URL = "https://rbnkhubtltjybaykdrgf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJibmtodWJ0bHRqeWJheWtkcmdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Njg2MTAsImV4cCI6MjA3NjE0NDYxMH0.EqBPx2aShr5MTsLd7nDuvmsuFYAQhNAKIrtLrX_VYfQ";

    // Admin notification email (for reference)
    const ADMIN_EMAIL = "chutkki.2025@gmail.com";

    // Initialize Supabase client
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });

    // ---------------------------
    // Utility helpers
    // ---------------------------
    const categoryColors = {
      Trending: 'linear-gradient(90deg,#f97316,#fb7185)',
      Upcoming: 'linear-gradient(90deg,#06b6d4,#7c3aed)',
      Promo: 'linear-gradient(90deg,#f59e0b,#ef4444)',
      World: 'linear-gradient(90deg,#34d399,#60a5fa)',
      Virtual: 'linear-gradient(90deg,#8b5cf6,#06b6d4)'
    };

    function Tag({ category }) {
      const style = { background: categoryColors[category] || 'rgba(255,255,255,0.06)', padding:'4px 8px', borderRadius:999, color:'#fff', fontWeight:700, fontSize:12, display:'inline-block' };
      return e('span', { style }, category || 'Event');
    }

    function formatDate(d) {
      try { return new Date(d).toLocaleString(); } catch { return d || ''; }
    }

    // Haversine distance (km)
    function haversine(lat1, lon1, lat2, lon2) {
      const toRad = v => v * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.asin(Math.sqrt(a));
    }

    // ---------------------------
    // Custom hooks for autoscroll
    // ---------------------------
    function useContinuousScroll(ref, speed = 0.4) {
      useEffect(() => {
        const el = ref.current;
        if (!el) return;
        if (!el.dataset.looped) {
          el.dataset.looped = "1";
          const kids = Array.from(el.children);
          kids.forEach(k => el.appendChild(k.cloneNode(true)));
        }
        let pos = 0;
        let raf = null;
        const step = () => {
          pos += speed;
          if (pos >= el.scrollWidth / 2) pos = 0;
          el.scrollLeft = pos;
          raf = requestAnimationFrame(step);
        };
        raf = requestAnimationFrame(step);
        return () => cancelAnimationFrame(raf);
      }, [ref, speed]);
    }

    function useCarouselAuto(trackRef, itemCount, delay = 3000) {
      useEffect(() => {
        const track = trackRef.current;
        if (!track || itemCount <= 1) return;
        let idx = 0;
        const tick = () => {
          idx = (idx + 1) % itemCount;
          const w = track.children[0]?.offsetWidth || 300;
          track.style.transform = 'translateX(' + (-idx * w) + 'px)';
        };
        const t = setInterval(tick, delay);
        return () => clearInterval(t);
      }, [trackRef, itemCount, delay]);
    }

    // ---------------------------
    // UI components
    // ---------------------------
    function EventCard({ it, compact=false }) {
      const image = it.image_url || ('https://picsum.photos/seed/' + (it.id || Math.random()) + '/600/300');
      return e('div', { className: 'section-card fade-in' },
        e('img', { src: image, className: 'event-image', alt: it.title }),
        e('div', { style: { display:'flex', justifyContent:'space-between', alignItems:'center' } },
          e('div', { style: { fontWeight:700 } }, it.title),
          e('div', null, e(Tag, { category: it.category }))
        ),
        e('div', { className: 'small', style: { marginTop:6 } }, (it.location || 'Online') + ' • ' + formatDate(it.date || it.date_iso || it.created_at)),
        compact ? null : e('div', { style: { marginTop:8, color:'#cfe7f0' } }, (it.description || '').slice(0,200))
      );
    }

    // ---------------------------
    // Main App
    // ---------------------------
    function App() {
      // auth
      const [user, setUser] = useState(null);

      // data
      const [trending, setTrending] = useState([]);
      const [upcoming, setUpcoming] = useState([]);
      const [promo, setPromo] = useState([]);
      const [worldEvents, setWorldEvents] = useState([]);
      const [virtuals, setVirtuals] = useState([]);
      const [pending, setPending] = useState([]);
      const [audit, setAudit] = useState([]);

      // UI / filters
      const [filters, setFilters] = useState({ q:'', category:'', date_from:'', date_to:'', lat:'', lng:'', dist:'' });
      const [page, setPage] = useState(1);
      const [limit, setLimit] = useState(12);
      const [theme, setTheme] = useState(localStorage.getItem('chutki_theme') || 'dark');

      // refs for auto-scroll
      const trendingRef = useRef(null);
      const worldRef = useRef(null);
      const promoTrack = useRef(null);
      const virtualTrack = useRef(null);

      // map ref
      const mapRef = useRef(null);

      useContinuousScroll(trendingRef, 0.45);
      useContinuousScroll(worldRef, 0.35);
      useCarouselAuto(promoTrack, Math.max(1, promo.length), 3500);
      useCarouselAuto(virtualTrack, Math.max(1, virtuals.length), 3500);

      useEffect(() => { document.body.classList.toggle('light', theme === 'light'); localStorage.setItem('chutki_theme', theme); }, [theme]);

      useEffect(() => {
        // restore session & subscribe auth changes
        const session = supabase.auth.getSession().then(r => {
          const s = r.data?.session || null;
          if (s && s.user) {
            setUser({ id: s.user.id, email: s.user.email, name: s.user.user_metadata?.full_name || s.user.user_metadata?.name || null });
            ensureUserProfile(s.user);
          } else {
            // try local auth state
            const local = null;
          }
        });

        supabase.auth.onAuthStateChange((event, session) => {
          if (session && session.user) {
            setUser({ id: session.user.id, email: session.user.email, name: session.user.user_metadata?.full_name || session.user.user_metadata?.name || null });
            ensureUserProfile(session.user);
          } else {
            setUser(null);
          }
        });

        loadAll();
      }, []);

      // ensure user profile row
      async function ensureUserProfile(supUser) {
        try {
          const { data } = await supabase.from('users').select('id,full_name,email,is_admin').eq('id', supUser.id).single().catch(()=>({ data:null }));
          if (!data) {
            await supabase.from('users').insert([{ id: supUser.id, email: supUser.email, full_name: supUser.user_metadata?.name || supUser.user_metadata?.full_name || null }]);
          }
        } catch (e){ console.error(e); }
      }

      async function loadAll() {
        // fetch sections (small limits)
        const [t, u, p, w, v] = await Promise.all([
          fetchSection('trending', 12),
          fetchSection('upcoming', 12),
          fetchSection('promo', 8),
          fetchSection('world', 20),
          fetchSection('virtual', 8)
        ]);
        setTrending(t || []);
        setUpcoming(u || []);
        setPromo(p || []);
        setWorldEvents(w || []);
        setVirtuals(v || []);
        setTimeout(()=> initMap((w || []).filter(it=>it.latitude && it.longitude)), 250);
        if (user) loadPending();
        loadAudit();
      }

      async function loadPending() {
        const { data } = await supabase.from('events').select('*, users(full_name)').eq('is_approved', false).order('created_at', { ascending:false });
        setPending(data || []);
      }

      async function loadAudit() {
        const { data } = await supabase.from('event_audit').select('*, events(title) ').order('created_at', { ascending:false }).limit(200);
        setAudit(data || []);
      }

      async function fetchSection(section, lim=12) {
        // calls /events with section param (client-side SQL via supabase)
        try {
          if (section === 'trending') {
            const { data } = await supabase.from('events').select('*, users(full_name)').eq('is_approved', true).order('created_at', { ascending: false }).limit(lim);
            return data || [];
          } else if (section === 'upcoming') {
            const { data } = await supabase.from('events').select('*, users(full_name)').gte('date', new Date().toISOString()).eq('is_approved', true).order('date', { ascending: true }).limit(lim);
            return data || [];
          } else if (section === 'promo') {
            const { data } = await supabase.from('events').select('*, users(full_name)').or('category.eq.Promo,title.ilike.%promo%').eq('is_approved', true).order('created_at', { ascending: false }).limit(lim);
            return data || [];
          } else if (section === 'world') {
            const { data } = await supabase.from('events').select('*, users(full_name)').not('latitude','is',null).not('longitude','is',null).eq('is_approved', true).order('created_at', { ascending: false }).limit(lim);
            return data || [];
          } else if (section === 'virtual') {
            const { data } = await supabase.from('events').select('*, users(full_name)').or('category.eq.Virtual,description.ilike.%virtual%,title.ilike.%virtual%').eq('is_approved', true).order('created_at', { ascending: false }).limit(lim);
            return data || [];
          } else {
            const { data } = await supabase.from('events').select('*, users(full_name)').eq('is_approved', true).order('date', { ascending: true }).limit(lim);
            return data || [];
          }
        } catch (err) {
          console.error('fetchSection', err);
          return [];
        }
      }

      // init leaflet map
      function initMap(items) {
        try {
          if (!document.getElementById('map')) return;
          if (!window._chutki_map) {
            window._chutki_map = L.map('map').setView([20,0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(window._chutki_map);
          }
          const map = window._chutki_map;
          // remove existing markers
          if (map._layers) {
            Object.keys(map._layers).forEach(k => {
              const layer = map._layers[k];
              if (layer instanceof L.Marker) map.removeLayer(layer);
            });
          }
          const markers = [];
          items.forEach(it => {
            const m = L.marker([it.latitude, it.longitude]).addTo(map).bindPopup('<b>' + (it.title||'') + '</b><br/>' + (it.location || ''));
            markers.push(m);
          });
          if (markers.length) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.2));
          }
        } catch(e) { console.error('map init', e); }
      }

      // ---------------------------
      // Auth handlers
      // ---------------------------
      async function signUp(email, password, name = null) {
        try {
          const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { name } } });
          if (error) throw error;
          alert('Signup initiated. Check email for confirmation if enabled.');
        } catch (err) { alert(err.message || err); }
      }

      async function logIn(email, password) {
        try {
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          if (data?.user) {
            setUser({ id: data.user.id, email: data.user.email, name: data.user.user_metadata?.name || null });
            ensureUserProfile(data.user);
            loadAll();
          }
        } catch (err) { alert(err.message || err); }
      }

      async function oauthLogin(provider) {
        try {
          const { data, error } = await supabase.auth.signInWithOAuth({ provider, options: { redirectTo: window.location.origin } });
          if (error) throw error;
          // Supabase will redirect automatically
        } catch (err) { console.error('oauth', err); alert('OAuth error'); }
      }

      async function logOut() {
        await supabase.auth.signOut();
        setUser(null);
      }

      // ---------------------------
      // Event CRUD
      // ---------------------------
      async function createEvent(payload) {
        try {
          // create event as is_approved=false (pending)
          const toInsert = {
            title: payload.title,
            description: payload.description || null,
            category: payload.category || 'Upcoming',
            image_url: payload.image_url || null,
            location: payload.location || null,
            latitude: payload.latitude || null,
            longitude: payload.longitude || null,
            date: payload.date,
            user_id: (user && user.id) || null,
            is_approved: false
          };
          const { data, error } = await supabase.from('events').insert([toInsert]).select().single();
          if (error) throw error;
          // audit
          await supabase.from('event_audit').insert([{ event_id: data.id, user_id: data.user_id, action: 'create' }]);
          alert('Event created and pending approval');
          loadAll();
          return data;
        } catch (err) { console.error(err); alert('Create failed: ' + (err.message||err)); }
      }

      async function approveEvent(id) {
        try {
          // only admins should call this — UI shows it when user.is_admin
          const { data, error } = await supabase.from('events').update({ is_approved: true }).eq('id', id).select().single();
          if (error) throw error;
          await supabase.from('event_audit').insert([{ event_id: id, user_id: user?.id || null, action: 'approve' }]);
          loadAll(); loadPending();
        } catch (err) { console.error(err); alert('Approve failed'); }
      }

      async function deleteEvent(id) {
        try {
          const { error } = await supabase.from('events').delete().eq('id', id);
          if (error) throw error;
          await supabase.from('event_audit').insert([{ event_id: id, user_id: user?.id || null, action: 'delete' }]);
          loadAll(); loadPending();
        } catch (err) { console.error(err); alert('Delete failed'); }
      }

      async function editEvent(id, updates) {
        try {
          const { data, error } = await supabase.from('events').update(updates).eq('id', id).select().single();
          if (error) throw error;
          await supabase.from('event_audit').insert([{ event_id: id, user_id: user?.id || null, action: 'update' }]);
          loadAll();
          return data;
        } catch (err) { console.error(err); alert('Update failed'); }
      }

      // ---------------------------
      // Contact form store
      // ---------------------------
      async function submitContact(payload) {
        try {
          const { name, email, message } = payload;
          if (!name || !email || !message) { alert('All fields required'); return; }
          const { error } = await supabase.from('contact_messages').insert([{ name, email, message }]);
          if (error) throw error;
          alert('Thanks — message saved. Admin will review.');
        } catch (err) { console.error(err); alert('Contact failed'); }
      }

      // ---------------------------
      // User "My Events"
      // ---------------------------
      const [myEvents, setMyEvents] = useState([]);
      async function loadMyEvents() {
        if (!user?.id) return;
        const { data } = await supabase.from('events').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
        setMyEvents(data || []);
      }

      // call loadMyEvents whenever user changes
      useEffect(()=> { if (user) loadMyEvents(); else setMyEvents([]); }, [user]);

      // ---------------------------
      // Admin flag
      // ---------------------------
      const [isAdmin, setIsAdmin] = useState(false);
      async function checkAdmin() {
        if (!user?.id) { setIsAdmin(false); return; }
        const { data } = await supabase.from('users').select('is_admin').eq('id', user.id).single().catch(()=>({ data:null }));
        setIsAdmin(!!(data && data.is_admin));
      }
      useEffect(()=> { checkAdmin(); }, [user]);

      // ---------------------------
      // Filters & search (client-side)
      // ---------------------------
      const [searchResults, setSearchResults] = useState([]);
      async function searchApply() {
        // a simple client-side combine of sections plus filter logic
        // For speed we pull a reasonable number of rows and filter in JS
        const { data } = await supabase.from('events').select('*, users(full_name)').eq('is_approved', true).order('date', { ascending: true }).limit(500);
        let items = data || [];
        const q = (filters.q || '').trim().toLowerCase();
        if (q) items = items.filter(it => (it.title||'').toLowerCase().includes(q) || (it.description||'').toLowerCase().includes(q) || (it.location||'').toLowerCase().includes(q));
        if (filters.category) items = items.filter(it => it.category === filters.category);
        if (filters.date_from) items = items.filter(it => new Date(it.date) >= new Date(filters.date_from));
        if (filters.date_to) items = items.filter(it => new Date(it.date) <= new Date(filters.date_to));
        if (filters.lat && filters.lng && filters.dist) {
          const latN = Number(filters.lat), lngN = Number(filters.lng), maxD = Number(filters.dist);
          items = items.map(it => it.latitude && it.longitude ? ({ ...it, distance_km: haversine(latN, lngN, Number(it.latitude), Number(it.longitude)) }) : it).filter(it => it.distance_km == null || it.distance_km <= maxD);
        }
        setSearchResults(items);
      }

      // ---------------------------
      // UI rendering
      // ---------------------------
      const promoTrackRef = promoTrack;
      const virtualTrackRef = virtualTrack;

      return e('div', { className: 'p-6 container mx-auto' },
        // header
        e('div', { style: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:12 } },
          e('div', { style:{display:'flex', alignItems:'center', gap:12} },
            e('div', { style:{width:56,height:56,borderRadius:12,background:'linear-gradient(135deg,#14b8a6,#60a5fa)',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:800,color:'#022'} }, 'EF'),
            e('div', null, e('h1', { style:{fontSize:20,fontWeight:800} }, 'Chutki — Event Finder'), e('div', { className:'small' }, 'Discover events worldwide'))
          ),
          e('div', null,
            user ? e('span', { className:'small mr-4' }, user.name || user.email) : null,
            user ? e('button', { className:'btn mr-2', onClick: logOut }, 'Logout') : null,
            !user ? e('button', { className:'btn mr-2', onClick: ()=>{ const email = prompt('Email'); const pwd = prompt('Password'); if(email&&pwd) logIn(email,pwd); } }, 'Login') : null,
            !user ? e('button', { className:'btn btn-primary mr-2', onClick: ()=>{ const name = prompt('Full name (optional)'); const email = prompt('Email'); const pwd = prompt('Password'); if(email&&pwd) signUp(email,pwd,name); } }, 'Signup') : null,
            !user ? e('button', { className:'oauth-btn mr-2', onClick: ()=> oauthLogin('google') }, 'Google') : null,
            !user ? e('button', { className:'oauth-btn', onClick: ()=> oauthLogin('facebook') }, 'Facebook') : null,
            e('button', { className:'btn ml-3', onClick: ()=> setTheme(theme === 'dark' ? 'light' : 'dark') }, theme === 'dark' ? 'Light' : 'Dark')
          )
        ),

        // top row: create event & contact & search
        e('div', { style: { display:'grid', gridTemplateColumns: '1fr 360px', gap:12, marginBottom:12 } },
          // left: create + filters
          e('div', { className:'card' },
            e('div', { style:{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8} },
              e('div', { style:{fontWeight:700} }, 'Create Event'),
              e('div', { className:'small' }, 'Posts require approval')
            ),
            e(CreateEventForm, { onCreate: createEvent, user }),
            e('hr', { style:{margin:'12px 0', borderColor:'rgba(255,255,255,0.03)'} }),
            e('div', null,
              e('div', { style:{fontWeight:700, marginBottom:6} }, 'Search & Filters'),
              e('div', { style:{display:'flex', gap:8, marginBottom:8} },
                e('input', { placeholder:'Keyword', value:filters.q, onChange: (ev)=> setFilters({ ...filters, q: ev.target.value }), className:'p-2 rounded w-full', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
                e('select', { value: filters.category, onChange: (ev)=> setFilters({ ...filters, category: ev.target.value }), className:'p-2 rounded', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} },
                  e('option', { value:'' }, 'All'),
                  ['Trending','Upcoming','Promo','World','Virtual'].map(c => e('option', { key:c, value:c }, c))
                )
              ),
              e('div', { style:{display:'flex', gap:8, marginBottom:8} },
                e('input', { type:'date', value: filters.date_from, onChange: (ev)=> setFilters({ ...filters, date_from: ev.target.value }), className:'p-2 rounded', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
                e('input', { type:'date', value: filters.date_to, onChange: (ev)=> setFilters({ ...filters, date_to: ev.target.value }), className:'p-2 rounded', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} })
              ),
              e('div', { style:{display:'flex', gap:8, marginBottom:8} },
                e('input', { placeholder:'Lat', value: filters.lat, onChange: (ev)=> setFilters({ ...filters, lat: ev.target.value }), className:'p-2 rounded', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
                e('input', { placeholder:'Lng', value: filters.lng, onChange: (ev)=> setFilters({ ...filters, lng: ev.target.value }), className:'p-2 rounded', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
                e('input', { placeholder:'Distance km', value: filters.dist, onChange: (ev)=> setFilters({ ...filters, dist: ev.target.value }), className:'p-2 rounded', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
                e('button', { className:'btn btn-primary', onClick: async ()=> { if(!filters.lat||!filters.lng) { navigator.geolocation?.getCurrentPosition(pos => setFilters({ ...filters, lat: pos.coords.latitude.toFixed(6), lng: pos.coords.longitude.toFixed(6) }), ()=>alert('Location denied')); } else { await searchApply(); } } }, 'Apply')
              ),
              e('div', null,
                e('button', { className:'btn', onClick: ()=> { setFilters({ q:'', category:'', date_from:'', date_to:'', lat:'', lng:'', dist:'' }); setSearchResults([]); loadAll(); } }, 'Reset')
              )
            )
          ),

          // right: contact + my events quick
          e('div', null,
            e('div', { className:'card', style:{marginBottom:12} },
              e('div', { style:{display:'flex', justifyContent:'space-between', alignItems:'center'} },
                e('div', { style:{fontWeight:700} }, 'Contact Us'),
                e('div', { className:'small' }, 'Messages saved')
              ),
              e(ContactForm, { onSubmit: submitContact })
            ),
            e('div', { className:'card' },
              e('div', { style:{display:'flex', justifyContent:'space-between', alignItems:'center'} },
                e('div', { style:{fontWeight:700} }, 'My Events'),
                e('div', { className:'small' }, 'Manage your posts')
              ),
              e('div', null,
                user ? e('div', null, myEvents.length === 0 ? e('div', null, 'You have no events') : myEvents.map(me => e('div', { key:me.id, style:{marginTop:8, border:'1px solid rgba(255,255,255,0.03)', padding:8, borderRadius:8} },
                    e('div', { style:{fontWeight:700} }, me.title),
                    e('div', { className:'small' }, me.category, ' • ', formatDate(me.date)),
                    e('div', { style:{marginTop:8} }, e('button', { className:'btn btn-primary mr-2', onClick: ()=> { const want = confirm('Delete event?'); if(want) deleteEvent(me.id); } }, 'Delete') )
                ))) : e('div', null, 'Login to see your events')
              )
            )
          )
        ),

        // map preview / trending row
        e('div', { className:'card', style:{marginBottom:12} },
          e('div', { style:{display:'flex', justifyContent:'space-between', alignItems:'center'} },
            e('div', { style:{fontWeight:700} }, 'Events'),
            e('div', null, e('button', { className:'btn', onClick: loadAll }, 'Refresh'))
          ),
          e('div', { id:'map', style:{marginTop:8} })
        ),

        // Sections: Trending (continuous)
        e('div', { className:'card fade-in', style:{marginBottom:12} },
          e('div', { style:{display:'flex', justifyContent:'space-between', alignItems:'center'} },
            e('h3', null, 'Trending'),
            e('div', { className:'small' }, 'Auto-scrolling')
          ),
          e('div', { ref: trendingRef, className:'section-row', style:{marginTop:8} },
            trending.length === 0 ? e('div', null, 'No trending events') : trending.map(it => e(EventCard, { it, key: it.id }))
          )
        ),

        // Promo (carousel)
        e('div', { className:'card fade-in', style:{marginBottom:12} },
          e('div', { style:{display:'flex', justifyContent:'space-between', alignItems:'center'} }, e('h3', null, 'Promotions'), e('div', { className:'small' }, 'Carousel')),
          e('div', { className:'carousel', style:{marginTop:8} },
            e('div', { ref: promoTrackRef, className:'carousel-track', style:{width: (Math.max(1,promo.length) * 320) + 'px'} },
              promo.length === 0 ? e('div', { className:'carousel-item section-card' }, 'No promotions') : promo.map(it => e('div', { className:'carousel-item section-card', key: it.id }, e('img', { src: it.image_url || ('https://picsum.photos/seed/' + it.id + '/600/300'), className:'event-image' }), e('div', { style:{fontWeight:700} }, it.title), e('div', { className:'small' }, it.category), e('div', null, (it.description||'').slice(0,120)))) )
            )
          )
        ),

        // Upcoming + map (small)
        e('div', { className:'card', style:{marginBottom:12} },
          e('div', { style:{display:'flex', justifyContent:'space-between', alignItems:'center'} },
            e('h3', null, 'Upcoming'),
            e('div', { className:'small' }, 'Soonest events')
          ),
          e('div', { style:{display:'grid', gridTemplateColumns:'1fr 420px', gap:12, marginTop:8} },
            e('div', null, upcoming.length === 0 ? e('div', null, 'No upcoming events') : upcoming.map(it => e('div', { className:'section-card', key: it.id }, e('img', { src: it.image_url || ('https://picsum.photos/seed/' + it.id + '/600/300'), className:'event-image' }), e('div', { style:{display:'flex',justifyContent:'space-between',alignItems:'center'} }, e('div', { style:{fontWeight:700} }, it.title), e(Tag, { category: it.category })), e('div', { className:'small' }, (it.location||'Online') + ' • ' + formatDate(it.date)), e('div', { style:{marginTop:6,color:'#cfe7f0'} }, (it.description||'').slice(0,140)) )) ),
            e('div', null, e('div', { id:'world-mini-map', style:{height:300, borderRadius:8} }) )
          )
        ),

        // World events (continuous)
        e('div', { className:'card fade-in', style:{marginBottom:12} },
          e('div', { style:{display:'flex', justifyContent:'space-between', alignItems:'center'} }, e('h3', null, 'Events Around The World'), e('div', { className:'small' }, 'Global highlights')),
          e('div', { ref: worldRef, className:'section-row', style:{marginTop:8} }, worldEvents.length === 0 ? e('div', null, 'No world events') : worldEvents.map(it => e(EventCard, { it, key: it.id })))
        ),

        // Virtual (carousel)
        e('div', { className:'card fade-in', style:{marginBottom:12} },
          e('div', { style:{display:'flex', justifyContent:'space-between', alignItems:'center'} }, e('h3', null, 'Virtual Events'), e('div', { className:'small' }, 'Online only')),
          e('div', { className:'carousel', style:{marginTop:8} },
            e('div', { ref: virtualTrackRef, className:'carousel-track', style:{width: (Math.max(1,virtuals.length) * 320) + 'px'} },
              virtuals.length === 0 ? e('div', { className:'carousel-item section-card' }, 'No virtual events') : virtuals.map(it => e('div', { className:'carousel-item section-card', key: it.id }, e('img', { src: it.image_url || ('https://picsum.photos/seed/' + it.id + '/600/300'), className:'event-image' }), e('div', { style:{fontWeight:700} }, it.title), e('div', { className:'small' }, it.category), e('div', null, (it.description||'').slice(0,120)) )))
            )
          )
        ),

        // admin panel (if admin)
        isAdmin ? e('div', { className:'card', style:{marginTop:12} },
          e('h3', { style:{fontWeight:700} }, 'Admin — Pending Events'),
          pending.length === 0 ? e('div', null, 'No pending events') : pending.map(p => e('div', { key:p.id, style:{marginBottom:8, border:'1px dashed rgba(255,255,255,0.03)', padding:8} }, e('div', { style:{fontWeight:700} }, p.title), e('div', { className:'small' }, p.category, ' • ', formatDate(p.created_at)), e('div', null, p.description || ''), e('div', { style:{marginTop:8} }, e('button', { className:'btn btn-primary mr-2', onClick: ()=> approveEvent(p.id) }, 'Approve'), e('button', { className:'btn', onClick: ()=> deleteEvent(p.id) }, 'Delete') )))
        ) : null,

        // audit log preview
        e('div', { className:'card', style:{marginTop:12} },
          e('h3', null, 'Recent Audit Log'),
          audit.length === 0 ? e('div', null, 'No audit entries') : audit.slice(0,20).map(a => e('div', { key: a.id, style:{marginBottom:8, borderTop:'1px solid rgba(255,255,255,0.03)', paddingTop:8} }, e('div', { className:'small' }, new Date(a.created_at).toLocaleString(), ' — ', a.action), e('div', null, a.events?.title || '') ))
        )
      );
    }

    // ---------------------------
    // CreateEventForm component
    // ---------------------------
    function CreateEventForm({ onCreate, user }) {
      const [state, setState] = useState({ title:'', description:'', category:'Upcoming', date:'', location:'', latitude:'', longitude:'', image_url:'' });

      return e('div', null,
        e('input', { placeholder:'Title', value: state.title, onChange: (ev)=> setState({ ...state, title: ev.target.value }), className:'p-2 rounded w-full mb-2', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
        e('input', { placeholder:'Category', value: state.category, onChange: (ev)=> setState({ ...state, category: ev.target.value }), className:'p-2 rounded w-full mb-2', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
        e('input', { placeholder:'Date (YYYY-MM-DD or ISO)', value: state.date, onChange: (ev)=> setState({ ...state, date: ev.target.value }), className:'p-2 rounded w-full mb-2', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
        e('textarea', { placeholder:'Description', value: state.description, onChange: (ev)=> setState({ ...state, description: ev.target.value }), className:'p-2 rounded w-full mb-2', rows:3, style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
        e('input', { placeholder:'Location (city, country)', value: state.location, onChange: (ev)=> setState({ ...state, location: ev.target.value }), className:'p-2 rounded w-full mb-2', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
        e('div', { style:{display:'flex', gap:8, marginBottom:8} },
          e('input', { placeholder:'Latitude', value: state.latitude, onChange: (ev)=> setState({ ...state, latitude: ev.target.value }), className:'p-2 rounded w-full', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
          e('input', { placeholder:'Longitude', value: state.longitude, onChange: (ev)=> setState({ ...state, longitude: ev.target.value }), className:'p-2 rounded w-full', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} })
        ),
        e('input', { placeholder:'Image URL (optional)', value: state.image_url, onChange: (ev)=> setState({ ...state, image_url: ev.target.value }), className:'p-2 rounded w-full mb-2', style:{background:'transparent', border:'1px solid rgba(255,255,255,0.04)'} }),
        e('div', { style:{display:'flex', gap:8} },
          e('button', { className:'btn btn-primary', onClick: ()=> { if (!state.title || !state.date) return alert('Title & date required'); onCreate(state); setState({ title:'', description:'', category:'Upcoming', date:'', location:'', latitude:'', longitude:'', image_url:'' }); } }, 'Post Event'),
          e('button', { className:'btn', onClick: ()=> { navigator.geolocation?.getCurrentPosition(p => setState({ ...state, latitude: p.coords.latitude.toFixed(6), longitude: p.coords.longitude.toFixed(6) }), err => alert(err.message)); } }, 'Use GPS')
        )
      );
    }

    // ---------------------------
    // ContactForm component
    // ---------------------------
    function ContactForm({ onSubmit }) {
      const [form, setForm] = useState({ name:'', email:'', message:'' });
      return e('form', { onSubmit: (ev)=> { ev.preventDefault(); onSubmit(form); setForm({ name:'', email:'', message:'' }); } },
        e('input
